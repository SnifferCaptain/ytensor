# YTensor

> ç°ä»£ C++20 è½»é‡çº§å¤šç»´å¼ é‡åº“ â€”â€” header-onlyï¼Œæç®€é›†æˆï¼Œç§‘ç ”/ç«èµ›/å·¥ç¨‹çš†å®œ

## ç‰¹æ€§äº®ç‚¹

- ğŸ§© **Header-only**ï¼šåªéœ€ `ytensor_single.hpp`ï¼Œé›¶ç¬¬ä¸‰æ–¹ä¾èµ–ï¼Œç›´æ¥ `#include` å³ç”¨
- ğŸ“ **ä»»æ„ç»´åº¦**ï¼šæ”¯æŒ shapeã€åˆ‡ç‰‡ã€è½¬ç½®ã€reshapeã€permute ç­‰å¸¸ç”¨æ“ä½œ
- âš¡ **å¤šåŠŸèƒ½**ï¼šæ”¯æŒå¹¶è¡Œã€å¹¿æ’­ã€åŸºç¡€æ•°å­¦ã€å°‘é‡å¸¸ç”¨çš„æ·±åº¦å­¦ä¹ å‡½æ•°ï¼ˆmatmul/softmax/attentionï¼‰
- ğŸ› ï¸ **æ˜“æ‰©å±•**ï¼šæºç æ¸…æ™°ï¼Œä¾¿äºäºŒæ¬¡å¼€å‘
- ğŸ—‚ï¸ **I/O æ”¯æŒ**ï¼šå¯ä¿å­˜/åŠ è½½ YTensor æ”¯æŒçš„æ–‡ä»¶
- ğŸ”¢ **å¹¿æ³›çš„ç±»å‹æ”¯æŒ**ï¼šæ”¯æŒå¸¸ç”¨çš„æ•°æ®ç±»å‹ï¼Œå¦‚ float16ï¼Œbfloat16ç­‰ã€‚

---

## è¿è¡Œç¤ºä¾‹

### ğŸš€ ç®€å•çš„è¯­è¨€æ¨¡å‹æ¨ç†
YTensorçš„åŠŸèƒ½å¹¶éçº¸ä¸Šè°ˆå…µï¼æ­¤é¡¹ç›®å·²ç»åœ¨exampleå†…å®Œæˆäº†å¯¹åŸºäºtransformeræ¶æ„çš„è¯­è¨€æ¨¡å‹æä¾›äº†åœ¨cpuä¸Šçš„æ¨ç†ç¤ºä¾‹ã€‚è¿è¡Œæµç¨‹å¦‚ä¸‹ï¼š
1. å‰å¾€huggingfaceä¸‹è½½æ¨¡å‹æƒé‡æ–‡ä»¶ã€‚æ¨¡å‹ç½‘å€ä¸º[https://huggingface.co/collections/SnifferCaptain/ymodel2](https://huggingface.co/collections/SnifferCaptain/ymodel2)ã€‚å¯ä»¥é€‰æ‹©çš„æ¨¡å‹æœ‰ï¼š  

| æ¨¡å‹åç§° | å‚æ•°é‡ | è¯´æ˜ |
| --- | --- | --- |
| ymodel2-s-2 | 11M | åŸºäºYModel2æ¶æ„çš„æœ€å°è¯­è¨€æ¨¡å‹ï¼Œå…·å¤‡æœ€åŸºç¡€çš„é—®ç­”èƒ½åŠ›ï¼Œé€‚åˆå…¥é—¨å’Œæµ‹è¯•ã€‚ |
| ymodel2-s0 | 99M | ä¸­ç­‰è§„æ¨¡çš„YModel2æ¶æ„è¯­è¨€æ¨¡å‹,åœ¨æ•°å­¦ã€ä»£ç èƒ½åŠ›ã€è‡ªç„¶çŸ¥è¯†æ–¹é¢éƒ½å…·å¤‡æ›´å¥½çš„æ€§èƒ½ã€‚|

2. ç‚¹å‡»é¡µé¢ä¸­çš„Files and versionsï¼ŒæŸ¥çœ‹ä»“åº“ä¸­çš„æ–‡ä»¶ã€‚ä¸‹è½½`tokenlizer.json`, `tokenlizer_config.json`ï¼Œä»¥åŠ`y2_sft_s-2.yt`ï¼ˆå¦‚æœæ˜¯ymodel2-s0çš„è¯ï¼Œä¸‹è½½`y2_sft_s-0.yt`ï¼‰ã€‚å°†ä¸‹è½½çš„ä¸‰ä¸ªæ–‡ä»¶æ”¾åˆ°example/ymodel2-s-2/modelç›®å½•ä¸‹ã€‚  

3. æ‰“å¼€main.cppï¼Œæ ¹æ®ä¸‹è½½çš„æ¨¡å‹ï¼Œè®¾ç½®æ¨¡å‹çš„å¤§å°é…ç½®ï¼š
```cpp
// åˆå§‹åŒ–æ¨¡å‹é…ç½®
ymodel2::YConfig2 config;
config.scale_lvl(-2);       // <-- å¦‚æœä¸‹è½½çš„æ¨¡å‹ä¸ºymodel2-s-2çš„è¯ï¼Œä½¿ç”¨-2ï¼›å¦‚æœæ˜¯ymodel2-s0çš„è¯ï¼Œä½¿ç”¨0ã€‚
```

4. ç¼–è¯‘è¿è¡Œï¼š
é¦–å…ˆæ¥åˆ°ç›®å½•example/ymodel2-s-2ä¸‹ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š
```bash
mkdir build
cd build
cmake ..
make -j8
./ymodel2-s-2
```
5. è¿è¡Œç»“æœå¦‚ä¸‹ï¼ˆä½¿ç”¨ymodel2-s-2ï¼‰ï¼š
```text
===SnifferCaptain Chat===

loading tokenizer...
tokenizer loaded successfully.
loading model weights...
  File contains 31 tensors
  lm_head.weight found in file (shared with embed_tokens)
  Successfully loaded 31/31 tensors
model loaded successfully.
using backend: naive
===============recipe================
  send your message with [Enter]
  'exit' or 'quit' to exit
  'clear' to clear chat history
======================================

You: ä½ å¥½ï¼ŒSnifferCaptainï¼ä½ å¯ä»¥æˆä¸ºæˆ‘çš„å¾—åŠ›åŠ©æ‰‹å—ï¼Ÿ
SnifferCaptain: ä½œä¸ºä¸€åç¨‹åºå‘˜ï¼Œæˆ‘å¯ä»¥ç»™ä½ æä¾›ä¸€äº›å»ºè®®ï¼Œå¸®åŠ©ä½ æˆä¸ºä¸€åæˆåŠŸçš„ç”¨æˆ·ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å»ºè®®å’ŒæŠ€å·§ï¼Œå¯ä»¥å¸®åŠ©ä½ å¼€å§‹ä½ çš„éœ€æ±‚ï¼š

1. **æ˜ç¡®ç›®æ ‡**ï¼šé¦–å…ˆï¼Œæ˜ç¡®ä½ çš„ç¤¾äº¤åœˆã€‚äº†è§£ä½ å¸Œæœ›é€šè¿‡çš„ä¸»é¢˜æˆ–æ•…äº‹æ¥æ„å»ºä½ çš„ç¤¾äº¤åœˆï¼Œä»¥å»ºç«‹èµ·æ‚¨çš„ä¿¡ä»»å’Œå‹è°Šã€‚

2. **è®¾è®¡æ•…äº‹**ï¼šæ ¹æ®ä½ çš„éœ€æ±‚è®¾è®¡ä¸€äº›ä¸»é¢˜ï¼Œå¦‚æ•…äº‹ã€ç§‘å­¦ã€å†å²æ•…äº‹ã€æ•…äº‹èƒŒæ™¯ç­‰ç­‰ã€‚ä¸åŒçš„è§†è§’å¯ä»¥å¸®åŠ©ä½ æ›´å¥½åœ°ç†è§£æ•…äº‹çš„ä¸»é¢˜å’Œæ€æƒ³ã€‚

3. **ä¸ªæ€§åŒ–ä½“éªŒ**ï¼šè€ƒè™‘ä½ çš„å…´è¶£çˆ±å¥½ã€å…´è¶£çˆ±å¥½æˆ–æ˜¯èŒä¸šå…´è¶£ã€‚è¿™å¯ä»¥åŒ…æ‹¬å…´è¶£çˆ±å¥½ã€è¿åŠ¨çˆ±å¥½ã€æ–‡åŒ–ä½“éªŒç­‰ã€‚åŒæ—¶ï¼Œæä¾›å¤šæ ·åŒ–çš„è§†è§’ï¼Œå¸®åŠ©ä½ æ›´æ·±å…¥åœ°äº†è§£ä½ æ‰€åœ¨ç¾¤ä½“çš„å…´è¶£å’Œç»å†ã€‚

4. **æŒç»­å­¦ä¹ **ï¼šæŠ€æœ¯å’ŒçŸ¥è¯†æ˜¯å­¦ä¹ æ–°æŠ€èƒ½çš„å…³é”®ã€‚æŒç»­å­¦ä¹ æ–°çŸ¥è¯†å’ŒæŠ€èƒ½å¯ä»¥å¸®åŠ©ä½ ä¿æŒç«äº‰åŠ›ã€‚åŒæ—¶ï¼Œå…³æ³¨ç”¨æˆ·åé¦ˆï¼Œäº†è§£è¡Œä¸šåŠ¨æ€ã€‚

5. **é€‚åº”æ€§å’Œçµæ´»æ€§**ï¼šå­¦ä¹ æ–°çš„æŠ€èƒ½å¯èƒ½ä¼šå¸¦æ¥æ–°çš„åˆ›ä½œæœºä¼šã€‚å°è¯•æ–°çš„è‰ºæœ¯å½¢å¼ï¼Œæˆ–è€…ä¸å…¶ä»–è‰ºæœ¯å®¶äº¤æµï¼Œè¿™å¯ä»¥æä¾›çµæ„Ÿã€‚

6. **å»ºç«‹äººè„‰**ï¼šå°è¯•ä¸æ‚¨æœ‰ç›¸ä¼¼å…´è¶£çš„äººå»ºç«‹è”ç³»ï¼Œå¯ä»¥å‡å°‘è¯¯è§£å’Œæ¬ºéª—ã€‚è¿™å¯ä»¥æä¾›æƒ…æ„Ÿæ”¯æŒå’Œé¼“åŠ±ï¼Œå¸®åŠ©ä½ æ‰©å¤§ä½ çš„å½±å“åŠ›ã€‚

7. **æŒç»­å­¦ä¹ **ï¼šæŠ€æœ¯çš„å‘å±•æ˜¯ä¸€ä¸ªæŒç»­çš„è¿‡ç¨‹ã€‚å°è¯•æ–°çš„æŠ€æœ¯ã€æ–°æ–¹æ³•æˆ–æ–¹æ³•ï¼Œä¿æŒå¥½å¥‡å¿ƒã€‚æŒç»­å­¦ä¹ æ–°æŠ€èƒ½ã€æ–°æŠ€èƒ½ï¼Œä½ ä¼šé€æ¸æå‡è‡ªå·±çš„éŸ³ä¹æ°´å¹³ã€‚

8. **è‡ªæˆ‘æ¿€åŠ±**ï¼šå­¦ä¹ æ–°æŠ€æœ¯å’ŒçŸ¥è¯†æ˜¯æˆåŠŸçš„å…³é”®å› ç´ ã€‚å‚åŠ ç¤¾åŒºæ´»åŠ¨ï¼Œæ— è®ºæ˜¯é€šè¿‡åœ¨çº¿è¯¾ç¨‹ã€æ•™å­¦æŠ€å·§ï¼Œè¿˜æ˜¯ç¼–ç¨‹ç¤¾åŒºã€‚è¿™äº›æ´»åŠ¨èƒ½å¤Ÿå¸®åŠ©ä½ ä¿æŒç«äº‰åŠ›ï¼Œä»è€Œæ¿€å‘ä½ çš„åˆ›é€ åŠ›ã€‚

9. **æŒç»­å­¦ä¹ å’Œæˆé•¿**ï¼šç¼–ç¨‹æ˜¯ä¸€ä¸ªæŒç»­çš„è¿‡ç¨‹ï¼Œéœ€è¦æ—¶é—´å’ŒåŠªåŠ›ã€‚ä¿æŒå¥½å¥‡å¿ƒå’Œç§¯æçš„å¿ƒæ€ï¼Œä¸æ–­å­¦ä¹ å’Œæˆé•¿ã€‚

10. **ä¿æŒè€å¿ƒ**ï¼šå­¦ä¹ å¹¶å°è¯•æ–°çš„æŠ€èƒ½ï¼Œè¿™å¯èƒ½ä¼šè®©ä½ æ›´åŠ åšå¼ºã€‚ä¿æŒç§¯æçš„å¿ƒæ€å¯¹å‰æçš„æ·±å¥½ä¿æŒä¿¡å¿ƒï¼Œè€Œä¸æ˜¯å¤±è´¥ã€‚

11. **ä¿æŒè€å¿ƒå’Œæ¯…åŠ›**ï¼šå­¦ä¹ æ–°æŠ€æœ¯éœ€è¦æ—¶é—´ã€‚ä¸è¦è®©ä»»ä½•äººçŸ¥é“ä½ å¸Œæœ›è·å¾—æŸäº›ä¸œè¥¿ã€‚ä¿æŒè€å¿ƒå’Œæ¯…åŠ›ï¼Œç›¸ä¿¡è‡ªå·±å¯ä»¥å…‹æœå›°éš¾ã€‚

æ¯ä¸ªäººçš„ä½“éªŒéƒ½æ˜¯ç‹¬ä¸€æ— äºŒçš„ï¼Œæ¯ä¸ªäººçš„ä»·å€¼å’Œæ„ä¹‰éƒ½ä¼šå½±å“ä½ çš„æˆåŠŸå’Œæˆå°±ã€‚é‡è¦çš„æ˜¯ä¿æŒå¼€æ”¾å’Œç§¯æçš„æ€åº¦ã€‚
[Info] encoding length: 43, decoding length: 576, encoding speed: 519.088 tokens/s, decoding speed: 193.069 tokens/s
       context length: 619/8192 tokens
```

## YTensor åŸºç¡€ç”¨æ³•

```cpp
// 1. åˆå§‹åŒ–å¼ é‡
yt::YTensor<float, 2> a(3, 4);                  // æ“ä½œå°†ä¼šé¢„å…ˆåˆ†é…å½¢çŠ¶ä¸º[3, 4]çš„å¼ é‡ï¼Œå…ƒç´ ä½¿ç”¨é»˜è®¤åˆå§‹åŒ–
auto b = yt::YTensor<float, 3>::ones(2, 3, 4);  // å…¨1åˆå§‹åŒ–ï¼Œå½¢çŠ¶ä¸º[2, 3, 4]

// 2. è®¿é—®å’Œä¿®æ”¹å…ƒç´ 
float v1 = a.at(1, 2);  // æ¨èï¼šå¿«é€Ÿè®¿é—®ä½äº(1, 2)çš„å…ƒç´ 
float v2 = a[1][2];     // ä¹Ÿå¯ä»¥ä½¿ç”¨ä¸‹æ ‡è®¿é—®ä½äº(1, 2)çš„å…ƒç´ 
b.at(0, 1, 2) = 42.f;   // å¯ä»¥èµ‹å€¼ä½äº(0, 1, 2)çš„å…ƒç´ 

// 3. è·å–å½¢çŠ¶ä¸å¤§å°
std::vector<int> shape = b.shape(); // è·å–å½¢çŠ¶
size_t sz = b.size();               // å…ƒç´ æ€»æ•°

// 4. è§†å›¾ä¸å˜æ¢
auto b2 = b.view(6, -1);    // å°†[2, 3, 4]å¼ é‡è½¬æ¢æˆ[6, 4]å¼ é‡ï¼Œå…¶ä¸­-1è¡¨ç¤ºæ ¹æ®å…ƒç´ æ•°é‡è‡ªåŠ¨è®¡ç®—çš„è½´é•¿ã€‚
b2 = b2.permute(1, 0);      // äº¤æ¢ç»´åº¦ï¼Œæ­¤æ—¶b2çš„å½¢çŠ¶ä¸º[4, 6]
b2 = b2.contiguous();       // å°†b2è½¬æ¢ä¸ºè¿ç»­å¼ é‡ï¼Œä¹Ÿç­‰ä»·äºb2.contiguous_()åŸåœ°æ“ä½œã€‚

// 5. æ‰“å° shape
std::cout << "shape: ";
for (int d : b2.shape()){
    std::cout << d << " ";
}
std::cout << std::endl;
```

> ä¸Šè¿°ä»£ç å±•ç¤ºäº† YTensor çš„å¸¸è§åˆå§‹åŒ–ã€å…ƒç´ è®¿é—®ã€å½¢çŠ¶è·å–ä¸è§†å›¾æ“ä½œã€‚æ›´å¤šç”¨æ³•è§ä¸‹æ–¹è¯¦ç»†åˆ†å—ä¸ example/ã€‚

---

## ğŸ§© Header-only é›¶ä¾èµ–
åªéœ€ä¸‹è½½ `single-header/ytensor_single.hpp`ï¼Œæ”¾åˆ°ä½ çš„å·¥ç¨‹ç›®å½•ï¼š

```cpp
#include "ytensor_single.hpp"   // ä»…éœ€åŒ…å«æ­¤æ–‡ä»¶å³å¯

int main() {
    auto a = yt::YTensor<float, 2>::randn(3, 4);    // [3, 4] æ­£æ€åˆ†å¸ƒéšæœºå¼ é‡
    std::cout << a << std::endl;                    // æ‰“å°å¼ é‡è¯¦ç»†ä¿¡æ¯
    return 0;
}
```
> åªéœ€ä¸€ä¸ªå¤´æ–‡ä»¶ï¼Œé›¶ä¾èµ–ï¼Œå¯ä»¥å¿«é€Ÿåœ¨ä»»æ„ C++20 é¡¹ç›®ä¸­ä½¿ç”¨ã€‚
> 
> **æ³¨æ„ï¼š** YTensor ä½¿ç”¨äº†å¤§é‡ C++20 ç‰¹æ€§ï¼Œè¯·ç¡®ä¿ä½ çš„ç¼–è¯‘å™¨æ”¯æŒ C++20ã€‚

---

## ğŸ“ ä»»æ„ç»´åº¦ä¸å¸¸ç”¨æ“ä½œ
æ”¯æŒ shapeã€åˆ‡ç‰‡ã€è½¬ç½®ã€reshapeã€permute ç­‰å¸¸ç”¨å¼ é‡æ“ä½œã€‚

```cpp
yt::YTensor<float, 3> t(4, 5, 3);   // æ„é€ ä¸€ä¸ª4x5x3çš„å¼ é‡
t.fill(1.0f);                       // å°†æ‰€æœ‰å…ƒç´ è®¾ä¸º 1.0

// é“¾å¼å•è¯­å¥å†™æ³•
auto sliced = t
    .permute(1, 2, 0)    // è°ƒæ¢è½´çš„æ’åˆ—é¡ºåºï¼š[4, 5, 3] -> [5, 3, 4]
    .contiguous()        // ä¿è¯å†…å­˜è¿ç»­æ€§ï¼Œæ˜¯viewä½¿ç”¨çš„å¿…è¦æ¡ä»¶ã€‚
    .view(15, -1)        // å°†å‰ä¸¤ä¸ªè½´èåˆ [3, 4, 5] -> [15, 4]
    .slice(1, 1, 3, 1);  // åœ¨è½´ 1 ä¸Šåˆ‡å–ç´¢å¼•1ã€2ï¼Œ[15, 4] -> [15, 2]

// æŸ¥çœ‹å½¢çŠ¶
const auto& s = sliced.shape();
std::cout << "shape: [";
for (size_t i = 0; i < s.size(); ++i) {
    std::cout << s[i];
    if (i + 1 < s.size()) std::cout << ", ";
}
std::cout << "]\n";
```
---

## âš¡ å¤šåŠŸèƒ½ï¼šæ”¯æŒå¤šç§è®¡ç®—

```cpp
// ReLU æ¿€æ´»ï¼ˆç›´æ¥ä½¿ç”¨åº“å‡½æ•°ï¼‰
auto x = yt::YTensor<float, 2>::randn(3, 4);    // éšæœºåˆå§‹åŒ–x: [3, 4]
auto y = yt::YTensor<float, 2>::randn(1, 4);    // éšæœºåˆå§‹åŒ–y: [1, 4]
auto reluOutput = yt::function::relu(x);        // é€å…ƒç´  reluã€‚reluOutput: [3, 4]

// æ”¯æŒé«˜è‡ªç”±åº¦çš„å…ƒç´ çº§å¹¿æ’­è®¡ç®—ã€‚siluOutput: [3, 4]
auto siluOutput = x.broadcastInplace([](float& v) {
    float s = 1.0f / (1.0f + std::exp(-v)); // sigmoid
    v = v * s;
});

// æ”¯æŒå…ƒç´ çº§åˆ«çš„å¤šå…ƒè‡ªå®šä¹‰è®¡ç®—ã€‚out: [3, 4]
auto out = yt::kernel::broadcast([](
    const float& t1,    // æ¥è‡ªå¼ é‡xçš„å…ƒç´ 
    const float& t2,    // æ¥è‡ªå¼ é‡yçš„å…ƒç´ 
    const float& t3,    // æ¥è‡ªå¼ é‡reluOutputçš„å…ƒç´ 
    const float& t4,    // æ¥è‡ªå¼ é‡siluOutputçš„å…ƒç´ 
    const float& s5,    // æ¥è‡ªå¸¸é‡
){
    return t1 + t2 + t3 + t4 + s5;
}, x, y, reluOutput, siluOutput, 0.5f); // è¾“å…¥éœ€è¦ä¸å‡½æ•°çš„å‚æ•°ä¸€ä¸€å¯¹é½

// ä¹Ÿæ”¯æŒä¸€äº›ç¬¦å·å¹¿æ’­è¿ç®—
out += y - 0.1f;

std::cout << "ReLU output:\n" << reluOutput << std::endl;
std::cout << "SiLU output:\n" << siluOutput << std::endl;
std::cout << "Custom output:\n" << out << std::endl;
```

æ”¯æŒå¸¸ç”¨æ“ä½œï¼Œå¯¹è‡ªå®šä¹‰æ“ä½œæœ‰æé«˜çš„è‡ªç”±åº¦ï¼Œç¤ºä¾‹å±•ç¤ºäº†åº“åŸè¯­åœ¨æ„å»ºè‡ªå®šä¹‰ç®—å­æ—¶çš„çµæ´»æ€§ä¸é«˜æ‰©å±•æ€§ã€‚

---
## ğŸ¦¾ å¤šç±»å‹æ”¯æŒ
æ”¯æŒå¤šç§æ•°æ®ç±»å‹çš„å¼ é‡ï¼ŒåŒ…æ‹¬æ ‡å‡†åº“ç±»å‹floatã€std::stringç­‰ï¼Œä¹Ÿæ”¯æŒè‡ªå®šä¹‰ç±»å‹ï¼Œèƒ½å¦ä½¿ç”¨å–å†³äºæ˜¯å¦å¯¹ç±»å‹è¿›è¡Œå¯¹åº”è¿ç®—ç¬¦ç¬¦çš„é‡è½½ã€‚
```cpp
yt::YTensor<std::string, 2> strTensor(3, 4);    // åˆ›å»ºä¸€ä¸ª3x4çš„std::stringç±»å‹å¼ é‡
strTensor.fill("hello");                        // åˆå§‹åŒ–ä¸º"hello"
strTensor += " world";                          // å¹¿æ’­åŠ æ³•ï¼ˆå­—ç¬¦ä¸²æ‹¼æ¥ï¼‰
std::cout << strTensor << std::endl;            // æ‰“å°å¼ é‡
std::cout << strTensor[0][0] << std::endl;      // è®¿é—®å…ƒç´ 

// å¯¹äºè‡ªå®šä¹‰ç±»å‹ï¼Œæä¾›ç±»å‹æ³¨å†Œæœºåˆ¶
struct MyType {
    int value = 0;
    MyType operator+(const MyType& other) const{
        return MyType{value - other.value};// åªè¦æœ‰è‡ªå®šä¹‰è¿ç®—ç¬¦å³å¯æ”¯æŒç›¸åº”è¿ç®—
    }
    // ...
};

// æ³¨å†Œç±»å‹ï¼Œå¹¶æä¾›å­—ç¬¦ä¸²çš„è½¬æ¢å‡½æ•°ã€‚éœ€è¦æä¾›ç±»å‹åç§°ä¸ç±»å‹è½¬æ¢å‡½æ•°ï¼ˆå¯é€‰ï¼Œå½±å“æ‰“å°è¾“å‡ºï¼‰
yt::types::registerType<MyType>("MyType", [](const void* data) {
    const MyType* p = reinterpret_cast<const MyType*>(data);// è½¬ä¸ºMyTypeæŒ‡é’ˆ
    return std::to_string(p->value + 1);// ç›´æ¥ä½¿ç”¨value+1ä¸ºæ‰“å°å†…å®¹
});

yt::YTensor<MyType, 2> myTensor(2, 3);
static int i = 0;
myTensor.foreach([&](auto& x){
    x.value = i++;
});
myTensor += MyType{5};
myTensor[0][0].value = 114513;
std::cout << myTensor << std::endl;
/*è¾“å‡ºç¤ºä¾‹ï¼š
[YTensor]:<MyType>
[itemSize]: 6
[byteSize]: 24
[shape]: [2, 3]
[data]:
[
  [114514 -3 -2]
  [-1 0 1]
]
*/
```

---

## ğŸ—‚ï¸ I/O æ”¯æŒ
å¯ä¿å­˜/åŠ è½½è‡ªå®šä¹‰äºŒè¿›åˆ¶æ ¼å¼ï¼Œæ”¯æŒå‹ç¼©ï¼ˆéœ€ zlibï¼‰ã€‚é€‚åˆé«˜æ•ˆåºåˆ—åŒ–ä¸è·¨å¹³å°æ•°æ®äº¤æ¢ã€‚

```cpp
yt::io::verbose = true;     // æ‰“å°è¯¦ç»†ä¿¡æ¯ï¼ˆé»˜è®¤å…³é—­ï¼‰
yt::io::compressMethod = "";// ä¸å‹ç¼©ï¼ˆé»˜è®¤ä¸å‹ç¼©ï¼Œzlibå¯¹æµ®ç‚¹æ•°çš„å‹ç¼©æ•ˆæœå¹¶ä¸å¥½ï¼‰

auto t0 = yt::YTensor<float, 2>::randn(3, 4);
auto t1 = yt::YTensor<float, 3>::randn(5, 6, 7);
yt::io::YTensorIO io;               // åˆ›å»ºæ–‡ä»¶IOå¯¹è±¡
io.open("./test.yt", yt::io::Write);// æ‰“å¼€æ–‡ä»¶ï¼Œå†™æ¨¡å¼
io.save(t0, "name0");               // ä¿å­˜å¼ é‡åˆ°æ–‡ä»¶
io.save(t1, "name1");               // æ”¯æŒå¤šå¼ é‡ä¿å­˜
io.close();                         // å…³é—­æ–‡ä»¶ï¼Œå†™å…¥ç£ç›˜

// åŠ è½½æ–‡ä»¶
io.open("./test.yt", yt::io::Read); // æ‰“å¼€æ–‡ä»¶ï¼Œè¯»æ¨¡å¼
yt::YTensor<float, 2> read0;
yt::YTensor<float, 3> read1;
yt::YTensorBase base0;
io.load(read0, "name0");    // åŠ è½½å¼ é‡ï¼Œæ³¨æ„æ•°æ®ç±»å‹ï¼ˆ<float, 2>ï¼‰éœ€è¦åŒ¹é…
io.load(read1, "name1");    // æ•°æ®ç±»å‹<float, 3>
io.load(base0, "name0");    // ä¹Ÿå¯ä»¥åŠ è½½åˆ°YTensorBaseå†…
io.close();

// âš ï¸ï¼šioæ¨¡å—å¯¹éPODç±»å‹ï¼ˆå¦‚std::stringè¿™ç§å†…éƒ¨å®ç°åŒ…å«æŒ‡é’ˆçš„ï¼‰å¹¶ä¸æ”¯æŒï¼Œåç»­æœ‰è®¡åˆ’æ·»åŠ æ”¯æŒã€‚
```
åŒæ—¶ï¼Œè¿˜å¯ä»¥ä½¿ç”¨example/convertç›®å½•ä¸‹çš„è½¬æ¢å‡½æ•°ã€‚å®ç°éƒ¨åˆ†çš„æ•°æ®æ ¼å¼è½¬æ¢ï¼ˆå¦‚numpyç­‰ï¼‰ã€‚
> é€‚åˆæ¨¡å‹æƒé‡ã€æ•°æ®é›†ç­‰ä¾¿æ·å­˜å‚¨ã€‚

---

## æ–‡ä»¶ç»“æ„

```tree
./
â”œâ”€ example/                                         | ç¤ºä¾‹ä»£ç 
â”‚  â”œâ”€ convert/                                      | æ•°æ®æ ¼å¼è½¬æ¢è„šæœ¬
â”‚  â”‚   â”œâ”€ __init__.py                               |
â”‚  â”‚   â”œâ”€ numpy2yt.py                               | numpyæ ¼å¼è½¬æ¢ä¸ºytensoræ ¼å¼[å¾…å®Œå–„]
â”‚  â”‚   â”œâ”€ savetensors2yt.py                         | ä¿å­˜ytensoræ ¼å¼ä¸ºnumpyæ ¼å¼[å¾…å®Œå–„]
â”‚  â”‚   â””â”€ ytfile.py                                 | ytensoræ–‡ä»¶ç±»[å¾…å®Œå–„]
â”‚  â””â”€ ymodel2-s-2/                                  | æ¨ç†ymodel2è¯­è¨€æ¨¡å‹ç¤ºä¾‹
â”‚      â”œâ”€ model/                                    | æ¨¡å‹æƒé‡ã€åˆ†è¯å™¨æ–‡ä»¶å­˜å‚¨
â”‚      â”‚   â”œâ”€ tokenlizer.json                       | è¯è¡¨æ–‡ä»¶ï¼Œéœ€è¦ä»huggingfaceä¸‹è½½
â”‚      â”‚   â”œâ”€ tokenlizer_config.json                | åˆ†è¯å™¨é…ç½®æ–‡ä»¶ï¼Œéœ€è¦ä»huggingfaceä¸‹è½½
â”‚      â”‚   â””â”€ y2_sft_s-2.yt                         | æ¨¡å‹æƒé‡æ–‡ä»¶ï¼Œéœ€è¦ä»huggingfaceä¸‹è½½
â”‚      â”œâ”€ CMakeLists.txt                            |
â”‚      â”œâ”€ json.hpp                                  | nlohmann jsonè§£æåº“
â”‚      â”œâ”€ main.cpp                                  | ä¸»ç¨‹åºå…¥å£
â”‚      â”œâ”€ tokenizer.cpp                             | åˆ†è¯å™¨å®ç°
â”‚      â”œâ”€ tokenizer.hpp                             | åˆ†è¯å™¨å¤´æ–‡ä»¶
â”‚      â”œâ”€ ymodel2.cpp                               | æ¨¡å‹å®ç°âœ¨
â”‚      â””â”€ ymodel2.hpp                               | æ¨¡å‹å¤´æ–‡ä»¶âœ¨
â”œâ”€ include/                                         | å¤´æ–‡ä»¶ç›®å½•
|  â”œâ”€ 3rd/                                          | ç¬¬ä¸‰æ–¹ä¾èµ–
â”‚  â”‚   â””â”€ backward.hpp                              | googleå †æ ˆè¿½è¸ªåº“ï¼Œå¯ä»¥ç§»é™¤ï¼Œæ–¹ä¾¿è°ƒè¯•ç”¨
â”‚  â”œâ”€ kernel/                                       | å†…æ ¸å®ç°
â”‚  â”‚   â”œâ”€ broadcast.hpp                             | å¹¿æ’­è¿ç®—
â”‚  â”‚   â”œâ”€ gemm.hpp                                  | çŸ©é˜µä¹˜æ³•
â”‚  â”‚   â”œâ”€ math_utils.hpp                            | æ•°å­¦å·¥å…·[å¾…å®Œå–„]
â”‚  â”‚   â”œâ”€ matmul_single.hpp [deprecated]            | å•ä¸ªçŸ©é˜µä¹˜æ³•[å·²ç»å¼ƒç”¨ï¼Œæ¥è‡ªsgemm.c]
â”‚  â”‚   â”œâ”€ memory_utils.hpp                          | å†…å­˜åˆ†é…
â”‚  â”‚   â””â”€ parallel_for.hpp                          | å¹¶è¡Œå¾ªç¯
â”‚  â”œâ”€ types/                                        | ç±»å‹ç›¸å…³
â”‚  â”‚   â”œâ”€ bfloat16.hpp                              | bfloat16ç±»å‹æ”¯æŒ
â”‚  â”‚   â””â”€ float_spec.hpp                            | å¤šç§æµ®ç‚¹æ•°ç±»å‹æ”¯æŒ
â”‚  â”œâ”€ ytensor_base_math.hpp                         | YTensoråŸºç±»æ•°å­¦æ“ä½œ
â”‚  â”œâ”€ ytensor_base.hpp                              | YTensoråŸºç±»
â”‚  â”œâ”€ ytensor_concepts.hpp                          | ç±»å‹æ£€æŸ¥ç­‰æ¦‚å¿µ
â”‚  â”œâ”€ ytensor_function.hpp                          | å‡½æ•°å¼ç¼–ç¨‹
â”‚  â”œâ”€ ytensor_infos.hpp                             | å…¨å±€è®¾ç½®ä¿¡æ¯
â”‚  â”œâ”€ ytensor_io.hpp                                | æ–‡ä»¶å­˜å‚¨ç³»ç»Ÿ
â”‚  â”œâ”€ ytensor_math.hpp                              | YTensoræ•°å­¦æ“ä½œ
â”‚  â”œâ”€ ytensor_preinstantiate.hpp                    | é¢„å®ä¾‹åŒ–[å¾…å®Œå–„]
â”‚  â””â”€ ytensor_types.hpp                             | ç±»å‹ç›¸å…³
â”œâ”€ single-header/                                   | å•å¤´æ–‡ä»¶ç‰ˆæœ¬
â”‚  â”œâ”€ ytensor_single.hpp                            | å•å¤´æ–‡ä»¶ç‰ˆæœ¬çš„YTensorï¼ŒåŒ…å«æ‰€æœ‰åŠŸèƒ½
â”‚  â””â”€ packer.py                                     | å•å¤´æ–‡ä»¶æ‰“åŒ…è„šæœ¬
â”œâ”€ src/                                             | æºæ–‡ä»¶å®ç°ç›®å½•
â”‚  â”œâ”€ ytensor_base_math.inl                         | YTensoråŸºç±»æ•°å­¦æ“ä½œ
â”‚  â”œâ”€ ytensor_base.inl                              | YTensoråŸºç±»
â”‚  â”œâ”€ ytensor_core.inl                              | YTensorå®ç°
â”‚  â”œâ”€ ytensor_function.inl                          | YTensorå‡½æ•°å¼ç¼–ç¨‹
â”‚  â”œâ”€ ytensor_io.inl                                | YTensoræ–‡ä»¶å­˜å‚¨ç³»ç»Ÿ
â”‚  â”œâ”€ ytensor_math.inl                              | YTensoræ•°å­¦æ“ä½œ
â”‚  â””â”€ ytensor.inl                                   | YTensorå®ç°[å·²åºŸå¼ƒ]
â””â”€ ytensor.hpp                                      | ä¸»å¤´æ–‡ä»¶ï¼ŒåŒ…å«æ‰€æœ‰å¿…è¦çš„å¤´æ–‡ä»¶
```
> YTensor ç‰ˆæœ¬ï¼š0.4ã€éæ­£å¼ã€‘  
**æ³¨æ„ï¼š å½“å‰ç‰ˆæœ¬ä»åœ¨å¿«é€Ÿè¿­ä»£ä¸­ï¼Œéƒ¨åˆ†ä¸å¸¸ç”¨æˆ–åº•å±‚API å¯èƒ½ä¼šæœ‰è¾ƒå¤§å˜åŠ¨ï¼Œè¯·å¯†åˆ‡å…³æ³¨æ›´æ–°æ—¥å¿—ã€‚**

---

## æœ€æ–°æ›´æ–°

- **è¿è¡Œæ—¶ç±»å‹åˆ†å‘æœºåˆ¶**ï¼šæ–°å¢ `kernel/type_dispatch.hpp`ï¼Œæ”¯æŒåŸºäºæ¨¡æ¿çš„é«˜æ•ˆè¿è¡Œæ—¶ç±»å‹åˆ†å‘ã€‚
- **æ‰©å±•è¿ç®—ç¬¦æ”¯æŒ**ï¼šæ–°å¢ä½ç§»è¿ç®—ç¬¦ã€å¸ƒå°”è¿ç®—ã€‚
- **ç±»å‹è½¬æ¢å¢å¼º**ï¼š`YTensorBase` æ–°å¢ `cast()` æ–¹æ³•ï¼Œæ”¯æŒåŠ¨æ€ç±»å‹è½¬æ¢ï¼›`copy_` æ”¯æŒä¸åŒç±»å‹é—´çš„è‡ªåŠ¨è½¬æ¢åŠå†…å­˜é‡å å¤„ç†ã€‚
- **è¿ç»­æ€§æ£€æŸ¥å¢å¼º**ï¼š`isContiguous()` æ”¯æŒæŒ‡å®šç»´åº¦èŒƒå›´åŠè´Ÿç´¢å¼•ã€‚
- **æ”¯æŒå¢åŠ **ï¼š`broadcast` å…¼å®¹ `YTensorBase`
- **è®¡ç®—ä¼˜åŒ–**ï¼š ä¼˜åŒ–äº†ç‰¹å®šæƒ…å†µä¸‹å¼ é‡çŸ©é˜µä¹˜æ³•å®ç°
- **ä¿®å¤**ï¼š ä¿®å¤äº†reluã€sigmoidå‡½æ•°çš„é”™è¯¯ã€‚
- **æ–‡æ¡£**ï¼š æ–°å¢å‚è€ƒæ–‡æ¡£âœ¨

---
å¦‚éœ€æ›´å¤šç¤ºä¾‹ã€API ç»†èŠ‚æˆ–è´¡çŒ®å»ºè®®ï¼Œæ¬¢è¿æŸ¥é˜… example/ ç›®å½•æˆ–æäº¤ issueï¼

