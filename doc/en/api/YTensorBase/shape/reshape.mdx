# Shape Operations: Reshaping

This document describes the reshaping methods for the `YTensorBase` class, including `view()`, `reshape()`, `contiguous()`, `contiguous_()`, and `mostContinuousView()`.

## Overview

| Method | Contiguity Required | Return Type | Possible Copy | Description |
| --- | --- | --- | --- | --- |
| `view()` | ✅ Required | New View | ❌ No | Zero-copy reshaping (only for contiguous tensors). |
| `reshape()` | ❌ No | New Tensor | ✅ Yes | Automatic contiguity handling. |
| `contiguous()` | ❌ No | New Tensor | ✅ Yes | Returns a contiguous version of the tensor. |
| `contiguous_()` | ❌ No | Self Reference | ✅ Yes | Converts the tensor to contiguous in-place. |
| `mostContinuousView()` | ❌ No | New View | ❌ No | Returns a view with the most contiguous dimension ordering. |

---

## `view()`

### Function Signatures

```cpp
YTensorBase view(const std::vector<int>& newShape) const;

template<typename... Args>
YTensorBase view(const Args... newShape) const;
```

### Parameters

| Name | Type | Description |
| --- | --- | --- |
| `newShape` | `std::vector<int>` or `Args...` | The new shape. A value of `-1` can be used once to automatically infer a dimension. |

### Core Function Description

Returns a view with the new shape (zero-copy).
*   **The tensor must be contiguous**, otherwise it throws a `std::runtime_error` exception.
*   Supports `-1` to automatically infer one dimension.

### Return Value

- **Type**: `YTensorBase`
- **Description**: Returns a view with the new shape (zero-copy).
- **Requirement**: **The tensor must be contiguous**; otherwise, it throws a `std::runtime_error`.

### Usage Example

```cpp
#include "ytensor_single.hpp"

void example() {
    YTensorBase mat = YTensorBase::zeros({3, 4}, "float32");
    
    // Reshape to [2, 6]
    YTensorBase reshaped = mat.view({2, 6});
    // reshaped.shape() -> {2, 6}
    
    // Use -1 for automatic inference
    YTensorBase auto_shape = mat.view({-1, 2});  // Resulting shape: {6, 2}
}
```

---

## `reshape()`

### Function Signatures

```cpp
YTensorBase reshape(const std::vector<int>& newShape) const;

template<typename... Args>
YTensorBase reshape(const Args... newShape) const;
```

### Core Function Description

A reshaping operation that automatically handles non-contiguous tensors. It is logically equivalent to `contiguous().view(newShape)`. If the tensor is already contiguous, it performs a zero-copy operation; otherwise, it creates a new copy.

### Usage Example

```cpp
YTensorBase mat = YTensorBase::zeros({3, 4}, "float32");

// Reshape can be called on non-contiguous tensors
YTensorBase transposed = mat.transpose();
YTensorBase reshaped = transposed.reshape({2, 6});  // Automatically creates a copy
```

### `view()` vs `reshape()`

| Feature | `view()` | `reshape()` |
| --- | --- | --- |
| **Contiguity Requirement** | ✅ Must be contiguous | ❌ No requirement |
| **Potential Copying** | ❌ Never copies | ✅ May copy |
| **Performance** | Fastest | Fast |
| **Use Case** | When contiguity is guaranteed | When contiguity is uncertain |

---

## `contiguous()`

### Function Signature

```cpp
YTensorBase contiguous() const;
```

### Core Function Description

Returns a contiguous version of the tensor. If the tensor is already contiguous, it returns a shallow copy (sharing memory); otherwise, it performs a deep copy to a new contiguous memory block.

### Usage Example

```cpp
YTensorBase mat = YTensorBase::zeros({3, 4}, "float32");
YTensorBase transposed = mat.transpose();

// Convert a non-contiguous tensor to contiguous
YTensorBase c = transposed.contiguous();
std::cout << c.isContiguous() << std::endl;  // Output: 1 (true)
```

---

## `contiguous_()`

### Function Signature

```cpp
YTensorBase& contiguous_();
```

### Core Function Description

Converts the tensor to a contiguous layout in-place. If the tensor is already contiguous, this is a no-op. Otherwise, it creates a new contiguous copy and replaces the current object's internal state.

### Usage Example

```cpp
YTensorBase tensor = YTensorBase::zeros({3, 4}, "float32");
tensor = tensor.transpose();  // Now non-contiguous

tensor.contiguous_();  // Convert in-place
std::cout << tensor.isContiguous() << std::endl;  // Output: 1 (true)
```

---

## `mostContinuousView()`

### Function Signature

```cpp
YTensorBase mostContinuousView() const;
```

### Core Function Description

Returns a view of the tensor that is as contiguous as possible. This is achieved by reordering dimensions based on stride sizes and converting negative strides to positive ones. Useful for optimizing performance-intensive lower-level operations.

### Usage Example

```cpp
YTensorBase tensor = YTensorBase::zeros({3, 4, 5}, "float32");
YTensorBase sliced = tensor.slice(0, 0, 2).slice(1, 1, 3);

YTensorBase mcv = sliced.mostContinuousView();
int cFrom = mcv.isContiguousFrom();
```

---

## `-1` Automatic Inference

Both `view()` and `reshape()` support using `-1` to automatically infer the size of one dimension:

```cpp
YTensorBase mat = YTensorBase::zeros({3, 4}, "float32");  // Total elements = 12

// Automatic inference with -1
YTensorBase a = mat.reshape({-1, 2});  // Resulting shape: {6, 2}
YTensorBase b = mat.reshape({2, -1});  // Resulting shape: {2, 6}
```

:::tip
Only one dimension can be set to `-1`, and the total number of elements must be divisible by the product of the other specified dimensions.
:::

---

## Notes

:::warning
**`view()` Requires Contiguity**

Calling `view()` on a non-contiguous tensor will throw an exception:
```cpp
YTensorBase transposed = mat.transpose();
// YTensorBase bad = transposed.view({4, 3});  // ❌ Throws std::runtime_error

// ✅ Correct approach:
YTensorBase good = transposed.contiguous().view({4, 3});
// OR use reshape() directly:
YTensorBase also_good = transposed.reshape({4, 3});
```
:::

---

## Related Content

- [Shape Queries](./query.mdx) - See the `isContiguous()` method.
- [Shape Operations: Slicing](./slice.mdx) - The `slice()` method.
- [Shape Operations: Transposition](./transpose.mdx) - Methods like `transpose()` and `permute()`.
- [Memory Management](../construction/memory.mdx) - The `clone()` method.
